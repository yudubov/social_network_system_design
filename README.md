### System Design социальной сети для курса по System Design

### Первоаначальная постановка задачи
У бизнеса есть четкое понимание функциональности, которая эта социальная сеть должна будет предоставлять в будущем:

- публикация постов из путешествий с фотографиями, небольшим описанием и привязкой к конкретному месту путешествия;
- оценка и комментарии постов других путешественников;
- подписка на других путешественников, чтобы следить за их активностью;
- поиск популярных мест для путешествий и просмотр постов с этих мест;
- просмотр ленты других путешественников и ленты пользователя, основанной на подписках в обратном хронологическом порядке;

> Что касается будущей аудитории социальной сети - у бизнеса есть огромные средства для рекламы и продвижения социальной сети,
> поэтому пользовательская база будет постепенно линейно расти и предполагается,
> что через год достигнет примерно 10 000 000 уникальных пользователей в день, после чего также будет продолжать расти.
> Бизнес пока нацелен  только на аудиторию стран СНГ (*на зарубежный рынок выходить планов нет*).
> Будущая система должна быть очень надежной, а также, чтобы с ней было удобно взаимодействовать, используя мобильные устройства и браузер.

Исходя из всего этого, в этой части домашнем задания нужно:
- формализовать функциональные и нефункциональные требования к будущей системе, используя полученную информацию от бизнеса, анализ конкурентов и ваш собственный инженерный и пользовательский опыт. 
- после этого, нужно будет примерно оценить нагрузку (RPS и трафик) на будущую систему. 
- оценку нагрузки рекомендуется проводить в разрезе по подсистемам (посты, реакции, комментарии) вашей будущей системы.


### Функциональные требования 
• Назначение системы - социальная сеть для путешественников
• Требуется разработать веб-версию и мобильную версия системы
• Отчеты и аналитика не требуются
• Основные сущности системы, которыми управляет пользователь: пост, реакция, комментарий, подписки/отписки
• Просмотр постов пользователей доступен, в обратном хронологическом порядке 
• Система должна предоставлять возможность поиска популярных мест для путешествий. (фильтрация постов пользователей по справочникам стран, городов и выдача результатов)
• Основные сущности системы, которыми управляет пользователь: пост, реакция, комментарий, подписки/отписки
• Функции системы с основными сущностями:
1. (запись - постов) создание и публикация поста: 
- до 6 фотографий с максимальным размером 500Кб
- описание до 250 символов 
- указание в посте страны и города путешествия (выбор из заранее предпоготовленных справочников стран и городов)   
2. (чтение - постов) просмотр постов пользователя (своих), в обратном хронологическом порядке 
3. (чтение - постов) просмотр постов других пользователей, в обратном хронологическом порядке

4. (запись - комментарий) создание комментария до 500 символов
5. (чтение - комментарий) возможность ознакомления с комментариями других пользователей о постах пользователя

6. (запись - реакция) оценка поста другого пользователя
7. (чтение - реакция) просмотр оценок своих постов

8. (запись - подписка/отписка) возможность подписываться/отписывать от других пользователей
9. (чтение - подписка/отписка) возможность ознакамливаться со списком подписчиков пользователя



### Нефункциональные требования
• Сезонность - активность пользователей на 50% возрастает в летнее время
• Низкий сезон DAU 10 000 000 (зима, весна, осень)
• Высокий сезон DAU 15 000 000 (летнее время)
• Аудитория СНГ
• Условия хранения данных по постам: 
- данные давностью менее 1 года должны подгружаться в системе <=2 секунд
- данные давностью более 1 года должны подгружаться в системе <=5 секунд
• Уровень доступности системы - 99,9% времени (допускается 9 часов в год недоступности системы)
• Вся история постов пользователей, комментарии, реакции хранятся в системе и доступны к просмотру
• Активности пользователей
Посты:
1. (запись - пост) в среднем каждый пользователь публикует 1 пост в день
2. (чтение - постов) в среднем каждый пользователь просматривает ленту своих постов 1 раз в день, со средней глубиной просмотра 10 постов 
3. (чтение - постов) в среднем каждый пользователь просматривает 50 постов других пользователей в день

Комментарии:
4. (запись - комментарий) в среднем каждый пользователь пишет по 5 комментариев к другим постам в день
5. (чтение - комментарий) в среднем каждый пользователь просматривает 5 новых коментариев в день

Реакции:
6. (запись - реакция) в среднем каждый пользователь оценивает 50 постов других пользователей в день
7. (чтение - реакция) в среднем каждый пользователь ознкамливается с 10 новыми оценками своих постов в день

Подписки/отписки:
8. (запись - подписки) в среднем каждый пользователь подписывается на других пользователей, для отслеживания их активности 1 раз в день
9. (запись - отписки) в среднем каждый пользователь отписывается от других пользователей 0,2 раза в день
10. (чтение - подписки/отписки) в среднем каждый пользователь ознакамливается со списком своих подписчиков 2 раза в день

• Лимиты 
Пользователь может писать не более 500 комментариев в день к другим постам
Пользователь может публиковать не более 20 своих постов в день
Пользователь может просматривать не более 2000 постов других пользователей в день
Пользователь может оценивать не более 500 постов в день
Пользователь может подписывать не более чем на 500 других пользователей в день


### Оценка весов
• Оценка веса поста:
author_user_id - 20 байт
post_id - 20 байт
created_at - 10 байт
title - 100 байт
comment - 500 байт
city - 5 байт
country - 5 байт
foto - 3072000 байт
hashtag - 100 байт
Вес поста = 3072760 байт / округлим до 3Мб

• Оценка веса комментария:
author_user_id - 20 байт
commentator_user_id - 20 байт
post_id - 20 байт
created_at - 10 байт
comment - 1000 байт
Вес комментария = 1070 байт / округлим до 1 кб

• Оценка веса реакции:
author_user_id - 20 байт
commentator_user_id - 20 байт
post_id - 20 байт
created_at - 10 байт
estimate - 5 байт
Вес реакции = 80 байт / округлим до 100 байт 

• Оценка веса подписки/отписки:
user_id - 20 байт
subscriber_user_id - 20 байт
created_at - 10 байт
is_subscription - 5 байт
Вес подписки/отписки = 55 байт  



### Оценка RPS - низкого сезона (летний сезон +50%):
• RPS посты 
Пользователь публикует 1 пост в день
RPS – write = 10 000 000 * 1 / 100 000 = 100

Пользователь читает 10 своих постов и 50 постов других пользователей
RPS – read = 10 000 000 * 60 / 100 000 = 6 000


• RPS комментарии 
Пользователь пишет 5 комментариев в день
RPS – write = 10 000 000 * 5 / 100 000 = 500

Пользователь читает 5 комментариев в день
RPS – read = 10 000 000 * 5 / 100 000 = 500


• RPS реакции 
Пользователь оценивает 50 постов других пользователей в день
RPS – write = 10 000 000 * 50 / 100 000 = 5 000

Пользователь ознкамливается с 10 новыми оценками своих постов
RPS – read = 10 000 000 * 10 / 100 000 = 1 000


• RPS подписки/отписки 
Пользователь подписывает 1 раз в день и отписывается 0,2 раза в день
RPS – write = 10 000 000 * 1,2 / 100 000 = 120

Пользователь ознакамливается со списком своих подписчиков 2 раза в день
RPS – read = 10 000 000 * 2 / 100 000 = 200 


### Оценка трафика
• Traffic посты 
100 RPS весом:
Метаданные - 1 КБ
Traffic – write meta = 100 * 3 = 300 КБ/c

Медиафайлы - 3 Мб
Traffic – write media = 100 * 3 = 300 Мб/c


6000 RPS весом:
Метаданные - 1 КБ
Traffic – read meta = 6000 * 1 = 18 000 КБ/c

Медиафайлы - 3 Мб
Traffic – read media = 6000 * 3 = 18 000 Mб/c


• Traffic комментарии 
500 RPS весом 1 кб 
Traffic – write = 500 * 1 = 500 кб/c

500 RPS весом 1 кб 
Traffic – read = 500 * 1 = 500 кб/c 


• Traffic реакции 
5 000 RPS весом 100 байт
Traffic – write = 5 000 * 100 = 500 000 байт/c - округлим до 500 кб/c  

1 000 RPS весом 100 байт
Traffic – read = 1 000 * 100 = 100 000 байт/c - округлим до 100 кб/c  


• Traffic подписки/отписки 
120 RPS весом 55 байт 
Traffic – write = 120 * 55 = 6 600 байт/c - округлим до 7 кб/c 

200 RPS весом 55 байт  
Traffic – read = 200 * 55 = 11 000 байт/c - округлим до 11 кб/c 


### Расчет одновременных соединений - низкого сезона (летнее сезон +50%):
Connections = 10 000 000 * 0.1 = 1 000 000 


### Вывод: 
Самая большая операция по RPS и трафику: чтение постов (6000 RPS, 18 000 Mб/c)
Приложение заточено больше на операцию чтение 


### API (псевдокод)
Посты:
• Создание поста - CreatePost(params) 
• Загрузка фотографий в пост - UploadPhotos(params)
• Чтение постов - ListPosts(params) 

Комментарии:
• Создание комментария поста - CreateComment(params) 
• Чтение комментариев постов - ListComments(params) 

Реакции оценки:
• Создание оценки поста - CreateRating(params) 
• Чтение оценок постов - ListRatings(params) 

Реакции подписки/отписки:
• Создание подписки/отписки на пользователя - CreateSubscription(params) 
• Чтение подписок/отписок пользователя - ListSubscriptions(params)




### Capacity (вместимость хранения данных в год с учетом сезонов):

• Capacity посты
Посты meta - низкий сезон = 300 КБ/c (Traffic – write) * 86400 (секунд в дне) * 275 (дней) = 7 128 000 000 КБ = 7 ТБ 
Посты meta - высокий сезон (лето) = 600 КБ/c * 86400 * 90 = 4 665 600 000 КБ = 5 ТБ
Итого meta посты в год = 12 ТБ

Посты media низкий сезон = 300 Мб/c * 86400 * 275 = 7 128 000 000 МБ = 7 ПБ
Посты media высокий сезон (лето) = 600 Мб/c * 86400 * 90 = 4 665 600 000 = 5 ПБ
Итого media посты в год = 12 ПБ


• Capacity комментарии 
Комментарии - низкий сезон = 500 КБ/c * 86400 * 275 = 11 880 000 000 КБ = 12 ТБ 
Комментарии - высокий сезон (лето) = 1 000 КБ/c * 86400 * 90 = 7 776 000 000 КБ = 8 ТБ 
Итого комментарии в год = 20 ТБ


• Capacity реакции (оценки)
Реакции - низкий сезон = 500 КБ/c * 86400 * 275 = 11 880 000 000 КБ = 12 ТБ 
Реакции - высокий сезон (лето) = 1 000 КБ/c * 86400 * 90 = 7 776 000 000 КБ = 8 ТБ 
Итого реакции в год = 20 ТБ


• Capacity подписки/отписки  
Подписки/отписки - низкий сезон = 7 КБ/c * 86400 * 275 = 166 320 000 КБ = 0,2 ТБ 
Подписки/отписки  - высокий сезон (лето) = 14 КБ/c * 86400 * 90 = 108 864 000 КБ = 0,1 ТБ 
Итого подписки/отписки  в год = 0,3 ТБ



### Расчет HDD/SSD
• PostgreSQL расчеты по подсистемам 
Комментарии расчет HDD/SSD
1. iops = суммарно 1000 RPS => у HDD 100 операций ввода-вывода в секунду => HHD 10 дисков (или 1 SSD sata)
2. Пропускная способность HDD 100 Мб/c - суммарный трафик 1000 кб/c => HHD 1 диск (или 1 SSD sata)
(учесть -20% недоступности данных диска)
3. Capacity вместимость - комментарии в год = 20 ТБ => HHD 1 диск (или 1 SSD sata)
- Итого комментарии (низкий сезон, летом увеличить в 2 раза):
(HDD) 14 дисков по 2TБ (недорогое железо и сложная конфигурация)
(SSD sata) 1 диск 32ТБ (дорогое железо и простая конфигурация)

Подписки/отписки расчет HDD
1. iops = суммарно 320 RPS => у HDD 100 операций ввода-вывода в секунду => HHD 4 диска 
2. Пропускная способность HDD 100 Мб/c - суммарный трафик 18 кб/c = HHD 1 диск 
(учесть -20% недоступности данных диска)
3. Capacity вместимость - подписки/отписки в год = 0,3 ТБ => HHD 1 диск 
- Итого подписки/отписки (низкий сезон, летом увеличить в 2 раза):
(HDD) 4 диска 128 Мб (недорогое железо и простая конфигурация)

Реакции расчет HDD
1. iops = суммарно 6000 RPS => у HDD 100 операций ввода-вывода в секунду => HHD 60 дисков (или 6 SSD sata)
2. Пропускная способность HDD 100 Мб/c - суммарный трафик 600 кб/c = HHD 1 диск (или 1 SSD sata)
(учесть -20% недоступности данных диска)
3. Capacity вместимость - реакции в год = 20 ТБ => HHD 1 диск 
- Итого реакции (низкий сезон, летом увеличить в 2 раза):
(HDD) 60 дисков по 512 Мб (недорогое железо и сложная конфигурация)
(SSD sata) 6 дисков 4 ТБ (дорогое железо и простая конфигурация)

Посты расчет meta HDD
1. iops = суммарно 6100 RPS => у HDD 100 операций ввода-вывода в секунду => HHD 61 диск (или 7 SSD sata)
2. Пропускная способность HDD 100 Мб/c - суммарный трафик 18 300 кб/c = HHD 1 диск (или 1 SSD sata)
(учесть -20% недоступности данных диска)
3. Capacity вместимость - посты meta в год = 12 ТБ => HHD 1 диск (или 1 SSD sata)
- Итого посты meta (низкий сезон, летом увеличить в 2 раза):
(HDD) 61 дисков по 512 Мб (недорогое железо и сложная конфигурация)
(SSD sata) 7 дисков 2 ТБ (дорогое железо и простая конфигурация)


• Хранилище S3 для media:
Посты расчет media HDD
1. iops = суммарно 6100 RPS => у HDD 100 операций ввода-вывода в секунду => HHD 61 диск (или 7 SSD sata)
2. Пропускная способность HDD 100 Мб/c - суммарный трафик 18 000 Мб/c = HHD 180 дисков (или 36 SSD sata)
(учесть -20% недоступности данных диска)
3. Capacity вместимость - посты media в год = 12 ПБ => HHD 500 дисков (или 150 SSD sata)
- Итого для постов media данных постов в S3 потребуется выделить (низкий сезон, летом увеличить в 2 раза):
(HDD) 500 дисков по 32 Тб (недорогое железо и очень сложная конфигурация)
(SSD sata) 150 дисков 100 ТБ (дорогое железо и сложная конфигурация)

Определенно, что media нужно сжимать и охлаждать. 
Но это я с удовольствием спроектирую в другой раз)) 


• Redis: 
Redis синхронизируется и хэширует ЧАСТЬ данных из PostgreSQL для ускорения выдачи постов золотых блогеров.
Хранится N последних постов золотых блогеров. N - настраивается конфигурацией. Золотой блогер определяется по признаку users.is_popular_blogger 
Реализован процесс, который через скрипты прогревает кэш. В случае перезагрузки сервиса, кэш атвоматически наполняется.
Алгоритм вытеснеия данных - FIFO
Метаданные 1 поста = 1 КБ
Для постов в оперативной памяти RAM выделяется 300 MБ = 300 000 постов золотых блоггеров


• ClickHouse
СlickHouse синхронизируется и дублирует данные из PostgreSQL для сложный аналитических запросов. 
Требуется выделить аналогичный объем для данных по подсистемам, как и для PostgreSQL. 


• Elasticsearch
Elasticsearch синхронизируется и дублирует данные из PostgreSQL для полнотекстового поиска. 
Промежуточный сервис определяет тип запроса (точный по id записи или текстовый) и направляет его в PostgreSQL или Elasticsearch.
Если текстовый запрос -> Elasticsearch находит максимально подходящие записи по релевантности -> направляет id записей в PostgreSQL -> PostgreSQL формирует набор записей для ответа по релевантнсотси 
Требуется выделить аналогичный объем для данных по подсистемам, как и для PostgreSQL.
